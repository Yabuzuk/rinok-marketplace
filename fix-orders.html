<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ Firebase</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 10px 0; font-size: 16px; }
    </style>
</head>
<body>
    <h1>üì¶ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ Firebase</h1>
    <button onclick="fixOrders()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
    <div id="log"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            updateDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyADaZYOM7nOITKBlfn0jhtwtTBI7RbB_m8",
            authDomain: "kalaktika-app.firebaseapp.com",
            projectId: "kalaktika-app",
            storageBucket: "kalaktika-app.firebasestorage.app",
            messagingSenderId: "735114029908",
            appId: "1:735114029908:web:8155afa0b285ce8c06f6c1",
            measurementId: "G-T7JLSH3WQS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const p = document.createElement('p');
            p.className = `log ${type}`;
            p.textContent = message;
            logDiv.appendChild(p);
            console.log(message);
        }

        window.fixOrders = async function() {
            log('üì¶ –ù–∞—á–∏–Ω–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤...');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                log('üë• –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = [];
                
                usersSnapshot.forEach((doc) => {
                    users.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                log(`–ù–∞–π–¥–µ–Ω–æ ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`, 'success');
                
                // –°–æ–∑–¥–∞–µ–º –º–∞–ø–ø–∏–Ω–≥ email -> –Ω–æ–≤—ã–π ID
                const emailToNewId = {};
                users.forEach(user => {
                    if (user.email) {
                        emailToNewId[user.email] = user.id;
                    }
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
                log('üìã –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã...');
                const ordersSnapshot = await getDocs(collection(db, 'orders'));
                const orders = [];
                
                ordersSnapshot.forEach((doc) => {
                    orders.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                log(`–ù–∞–π–¥–µ–Ω–æ ${orders.length} –∑–∞–∫–∞–∑–æ–≤`, 'success');
                
                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã
                let fixedCount = 0;
                let skippedCount = 0;
                
                for (const order of orders) {
                    const customerId = order.customerId;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º ID
                    const userExists = users.find(u => u.id === customerId);
                    
                    if (userExists) {
                        log(`‚úÖ –ó–∞–∫–∞–∑ ${order.id.slice(-8)} - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω`, 'success');
                        skippedCount++;
                        continue;
                    }
                    
                    // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Å—Ç–∞—Ä–æ–º—É ID –≤ –ø–æ–ª–µ customerId
                    // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Å—Ç–∞—Ä—ã–µ ID - —ç—Ç–æ —á–∏—Å–ª–æ–≤—ã–µ timestamp
                    if (customerId && /^\d+$/.test(customerId)) {
                        // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –º–æ–≥ –±—ã –±—ã—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
                        // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ email –∏–∑ –¥—Ä—É–≥–∏—Ö –∑–∞–∫–∞–∑–æ–≤ –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö
                        
                        log(`‚ö†Ô∏è –ó–∞–∫–∞–∑ ${order.id.slice(-8)} - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ${customerId} –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'warning');
                        
                        // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ email
                        // –ù–æ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–ª–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
                        
                        // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–∫–∞–∑—ã
                        log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–∞–∫–∞–∑–∞ ${order.id.slice(-8)}`, 'error');
                        skippedCount++;
                    } else {
                        log(`‚úÖ –ó–∞–∫–∞–∑ ${order.id.slice(-8)} - —É–∂–µ –∏–º–µ–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID`, 'success');
                        skippedCount++;
                    }
                }
                
                log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:`, 'success');
                log(`‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${fixedCount}`, 'success');
                log(`‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${skippedCount}`, 'warning');
                
                if (fixedCount === 0) {
                    log('‚ÑπÔ∏è –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Å–≤—è–∑–∏ —Å—Ç–∞—Ä—ã—Ö –∏ –Ω–æ–≤—ã—Ö ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'warning');
                    log('üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ –≤ –∑–∞–∫–∞–∑–∞—Ö email –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã', 'warning');
                }
                
                log('üéâ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
                
            } catch (error) {
                log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        };
    </script>
</body>
</html>