<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—ã—Å—Ç—Ä–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 5px; margin: 5px 0; border-radius: 3px; font-size: 12px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { padding: 15px 30px; margin: 10px 0; font-size: 18px; background: #ff6b35; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:hover { background: #e55a2b; }
        #progress { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; margin: 10px 0; }
        #progressBar { height: 100%; background: #4caf50; border-radius: 10px; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <h1>‚ö° –ë—ã—Å—Ç—Ä–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</h1>
    <button onclick="quickCleanDuplicates()">üóëÔ∏è –£–î–ê–õ–ò–¢–¨ –î–£–ë–õ–ò–ö–ê–¢–´</button>
    <div id="progress"><div id="progressBar"></div></div>
    <div id="log"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            deleteDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyADaZYOM7nOITKBlfn0jhtwtTBI7RbB_m8",
            authDomain: "kalaktika-app.firebaseapp.com",
            projectId: "kalaktika-app",
            storageBucket: "kalaktika-app.firebasestorage.app",
            messagingSenderId: "735114029908",
            appId: "1:735114029908:web:8155afa0b285ce8c06f6c1",
            measurementId: "G-T7JLSH3WQS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const p = document.createElement('p');
            p.className = `log ${type}`;
            p.textContent = message;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        window.quickCleanDuplicates = async function() {
            log('‚ö° –ë—ã—Å—Ç—Ä–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤...');
            updateProgress(10);
            
            try {
                const querySnapshot = await getDocs(collection(db, 'products'));
                const products = [];
                
                querySnapshot.forEach((doc) => {
                    products.push({
                        id: doc.id,
                        name: doc.data().name
                    });
                });
                
                log(`üì¶ –ù–∞–π–¥–µ–Ω–æ ${products.length} —Ç–æ–≤–∞—Ä–æ–≤`);
                updateProgress(30);
                
                // –ë—ã—Å—Ç—Ä–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
                const nameMap = new Map();
                const duplicates = [];
                
                products.forEach(product => {
                    const name = product.name.toLowerCase().trim();
                    if (nameMap.has(name)) {
                        duplicates.push(product.id);
                    } else {
                        nameMap.set(name, product.id);
                    }
                });
                
                log(`üîç –ù–∞–π–¥–µ–Ω–æ ${duplicates.length} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤`);
                updateProgress(50);
                
                if (duplicates.length === 0) {
                    log('üéâ –î—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!', 'success');
                    updateProgress(100);
                    return;
                }
                
                // –ë—ã—Å—Ç—Ä–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –±–∞—Ç—á–∞–º–∏ –ø–æ 10
                let deleted = 0;
                const batchSize = 10;
                
                for (let i = 0; i < duplicates.length; i += batchSize) {
                    const batch = duplicates.slice(i, i + batchSize);
                    
                    await Promise.all(batch.map(async (id) => {
                        try {
                            await deleteDoc(doc(db, 'products', id));
                            deleted++;
                        } catch (error) {
                            log(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è ${id}`, 'error');
                        }
                    }));
                    
                    const progress = 50 + (i / duplicates.length) * 50;
                    updateProgress(progress);
                    log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ ${deleted}/${duplicates.length}`);
                }
                
                updateProgress(100);
                log(`‚úÖ –ì–æ—Ç–æ–≤–æ! –£–¥–∞–ª–µ–Ω–æ ${deleted} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤`, 'success');
                log(`üìä –û—Å—Ç–∞–ª–æ—Å—å ${products.length - deleted} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤`, 'success');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        };
    </script>
</body>
</html>